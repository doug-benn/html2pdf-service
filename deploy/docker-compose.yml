services:
  redis:
    image: redis:8-alpine
    command:
    - redis-server
    - --maxmemory
    - ${REDIS_MAXMEMORY:-256mb}
    - --maxmemory-policy
    - ${REDIS_MAXMEMORY_POLICY:-volatile-lru}
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: html2pdf
      POSTGRES_USER: html2pdf
      POSTGRES_PASSWORD: html2pdf
    volumes:
    - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U html2pdf -d html2pdf
      interval: 5s
      timeout: 3s
      retries: 20
  auth-service:
    build: ../services/auth-service
    expose:
    - '9000'
    depends_on:
    - redis
    - postgres
    - auth-migrate
    volumes:
    - ../logs:/logs
    - ../services/auth-service/config/auth-service.yaml:/app/config/auth-service.yaml:ro
  auth-migrate:
    image: postgres:16
    depends_on:
    - postgres
    environment:
      PGPASSWORD: html2pdf
    volumes:
    - ../services/auth-service/deploy/postgres/migrations:/migrations:ro
    - ../services/auth-service/deploy/postgres/verify_tokens_schema.sql:/verify_tokens_schema.sql:ro
    command:
    - sh
    - -c
    - >-
      apt-get update;
      apt-get install -y postgresql-16-pgtap;
      rm -rf /var/lib/apt/lists/*;
      until pg_isready -h postgres -U html2pdf -d html2pdf; do sleep 1; done;
      psql -h postgres -U html2pdf -d html2pdf -v ON_ERROR_STOP=1 -f /migrations/001_create_tokens_table.sql;
      psql -h postgres -U html2pdf -d html2pdf -v ON_ERROR_STOP=1 -f /verify_tokens_schema.sql;
  html2pdf:
    build: ../services/pdf-renderer
    expose:
    - '8080'
    shm_size: 1gb
    depends_on:
    - redis
    environment:
      CHROME_BIN: /usr/bin/chromium-browser
    volumes:
    - ../examples:/app/examples
    - ../logs:/app/logs
    - ../services/pdf-renderer/config/html2pdf.yaml:/app/config/html2pdf.yaml:ro
  docs:
    build:
      context: ..
      dockerfile: frontend/nginx/Dockerfile
    expose:
    - '8080'
  envoy:
    image: envoyproxy/envoy:v1.30-latest
    depends_on:
    - docs
    - html2pdf
    - auth-service
    ports:
    - 80:80
    - 443:443
    volumes:
    - ../gateway/envoy/envoy.yaml:/etc/envoy/envoy.yaml:ro
    - ../gateway/envoy/tls:/etc/envoy/tls:ro
    command:
    - envoy
    - -c
    - /etc/envoy/envoy.yaml
    - --log-level
    - info
volumes:
  postgres_data: null
