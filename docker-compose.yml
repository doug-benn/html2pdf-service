services:
  redis:
    image: redis:8-alpine
    command:
      - redis-server
      - --maxmemory
      - ${REDIS_MAXMEMORY:-256mb}
      - --maxmemory-policy
      - ${REDIS_MAXMEMORY_POLICY:-volatile-lru}

  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: html2pdf
      POSTGRES_USER: html2pdf
      POSTGRES_PASSWORD: html2pdf
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # One-time init (only runs on first startup when the data dir is empty)
      - ./migrations/001_create_tokens_table.sql:/docker-entrypoint-initdb.d/001_create_tokens_table.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U html2pdf -d html2pdf"]
      interval: 5s
      timeout: 3s
      retries: 20

  auth-service:
    build: ./auth-service
    expose:
      - "9000"
    depends_on:
      - redis
      - postgres
    environment:
      AUTH_LISTEN: ":9000"
      AUTH_PG_DSN: "postgres://html2pdf:html2pdf@postgres:5432/html2pdf?sslmode=disable"
      AUTH_REDIS_ADDR: "redis:6379"
      AUTH_REDIS_RATE_DB: "0"
      AUTH_RL_INTERVAL: "1h"
      AUTH_TOKEN_RELOAD: "1m"
      AUTH_ENABLE_USER_LIMITER: "true"
      AUTH_USER_LIMIT: "20"
      # If you want to temporarily disable token rate limiting for debugging:
      # AUTH_ENABLE_TOKEN_LIMITER: "false"

  html2pdf:
    build: .
    expose:
      - "8080"
    shm_size: "1gb"
    depends_on:
      - redis
    environment:
      CHROME_BIN: /usr/bin/chromium-browser
    volumes:
      - ./examples:/app/examples
      - ./logs:/app/logs
      - ./config/html2pdf.yaml:/app/config/html2pdf.yaml:ro

  docs:
    image: nginxinc/nginx-unprivileged:alpine
    expose:
      - "8080"
    volumes:
      - ./docs:/usr/share/nginx/html:ro
      - ./config/nginx.conf:/etc/nginx/conf.d/default.conf:ro

  envoy:
    image: envoyproxy/envoy:v1.30-latest
    depends_on:
      - docs
      - html2pdf
      - auth-service
    ports:
      - "80:80"
    volumes:
      - ./config/envoy.yaml:/etc/envoy/envoy.yaml:ro
    command: ["envoy", "-c", "/etc/envoy/envoy.yaml", "--log-level", "info"]

volumes:
  postgres_data:
